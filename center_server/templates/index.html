<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Router Benchmark Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    <!-- Socket.IO for WebSocket communication -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- xterm.js for terminal emulation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: #f5f5f5;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #e5e5e5;
        }

        .tab.active {
            background: white;
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .stat-value.good { color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.bad { color: #ef4444; }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            color: #666;
            font-size: 14px;
        }

        .controls select, .controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .last-update {
            color: #999;
            font-size: 12px;
            margin-top: 10px;
        }

        .clients-section, .section-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .clients-count {
            color: #666;
            font-size: 14px;
        }

        .clients-table, .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .clients-table th, .results-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .clients-table td, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .clients-table tr:hover, .results-table tr:hover {
            background: #f9fafb;
        }

        .client-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* Admin Auth Section */
        .auth-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .auth-section .section-title {
            color: white;
            margin-bottom: 15px;
        }

        .auth-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .auth-form input {
            flex: 1;
            min-width: 300px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .auth-status {
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-status.authenticated {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }

        .auth-status.not-authenticated {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }

        /* Command Section */
        .command-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-group select, .form-group input, .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #666;
        }

        .command-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* Results Section */
        .result-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .result-meta-item {
            font-size: 13px;
        }

        .result-meta-item strong {
            color: #333;
        }

        .exit-code-success {
            color: #10b981;
            font-weight: bold;
        }

        .exit-code-error {
            color: #ef4444;
            font-weight: bold;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        .toast.info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .params-container {
            grid-column: 1 / -1;
            display: none;
        }

        .params-container.visible {
            display: block;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Web Shell Styles */
        .shell-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 250px);
            min-height: 400px;
        }

        .shell-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .shell-controls select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 250px;
        }

        .terminal-wrapper {
            flex: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .terminal-wrapper #terminal {
            height: 100%;
            padding: 10px;
        }

        .shell-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #1e1e1e;
            border-radius: 8px 8px 0 0;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 13px;
        }

        .shell-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .shell-status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
        }

        .shell-status-indicator.connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .shell-status-indicator.disconnected {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .shell-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 40px;
        }

        .shell-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            fill: #666;
        }

        .shell-placeholder h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .shell-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .shell-info h4 {
            color: #0369a1;
            margin-bottom: 8px;
        }

        .shell-info ul {
            margin-left: 20px;
            color: #0c4a6e;
            font-size: 14px;
        }

        .shell-info li {
            margin-bottom: 5px;
        }

        /* AI Troubleshoot Styles */
        .ai-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .ai-sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ai-sidebar h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .ai-sidebar .form-group {
            margin-bottom: 15px;
        }

        .ai-category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ai-category-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-category-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .ai-category-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .ai-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ai-status-card {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
        }

        .ai-status-indicator.not-configured {
            background: #f59e0b;
        }

        .ai-status-indicator.error {
            background: #ef4444;
        }

        .ai-result-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            overflow-y: auto;
        }

        .ai-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .ai-result-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-result-content h2 {
            color: #333;
            font-size: 18px;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #3b82f6;
        }

        .ai-result-content h2:first-child {
            margin-top: 0;
        }

        .ai-result-content ul, .ai-result-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .ai-result-content li {
            margin-bottom: 8px;
        }

        .ai-result-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .ai-result-content pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
        }

        .ai-result-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .ai-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
            color: #666;
            text-align: center;
        }

        .ai-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            fill: #9ca3af;
        }

        .ai-placeholder h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .ai-loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-config-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .ai-config-form .form-group {
            margin-bottom: 12px;
        }

        .ai-config-form .form-group:last-child {
            margin-bottom: 0;
        }

        .ai-question-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Router Benchmark Dashboard</h1>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('monitoring')">Monitoring</button>
            <button class="tab" onclick="switchTab('commands')">Remote Commands</button>
            <button class="tab" onclick="switchTab('shell')">Web Shell</button>
            <button class="tab" onclick="switchTab('ai')">AI Troubleshoot</button>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content active">
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="total-records">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 1 - Packet Loss</div>
                    <div class="stat-value" id="router1-loss">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 2 - Packet Loss</div>
                    <div class="stat-value" id="router2-loss">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 1 - Avg Latency</div>
                    <div class="stat-value" id="router1-latency">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 2 - Avg Latency</div>
                    <div class="stat-value" id="router2-latency">-</div>
                </div>
            </div>

            <div class="clients-section">
                <div class="section-header">
                    <div class="section-title">Active Clients</div>
                    <div class="clients-count" id="clients-count">-</div>
                </div>
                <div id="clients-table-container">
                    <div class="no-data">Loading clients...</div>
                </div>
            </div>

            <div class="controls">
                <label for="clientFilter">View Client:</label>
                <select id="clientFilter">
                    <option value="all" selected>All Clients</option>
                </select>

                <label for="timeRange" style="margin-left: 20px;">Time Range:</label>
                <select id="timeRange">
                    <option value="50">Last 50 records</option>
                    <option value="100" selected>Last 100 records</option>
                    <option value="200">Last 200 records</option>
                    <option value="500">Last 500 records</option>
                </select>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>

            <div class="chart-container">
                <div class="chart-title">Packet Loss % Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="lossChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Average Latency (ms) Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>

            <div class="last-update" id="lastUpdate">Last updated: -</div>
        </div>

        <!-- Commands Tab -->
        <div id="commands-tab" class="tab-content">
            <!-- Admin Authentication -->
            <div class="auth-section">
                <div class="section-title">Admin Authentication</div>
                <div class="auth-form">
                    <input type="password" id="adminApiKey" placeholder="Enter Admin API Key..." />
                    <button class="btn btn-success" onclick="saveAdminKey()">Save Key</button>
                    <button class="btn btn-secondary" onclick="clearAdminKey()">Clear</button>
                    <span class="auth-status not-authenticated" id="authStatus">Not Authenticated</span>
                </div>
            </div>

            <!-- Send Command -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">Send Command</div>
                </div>
                <div class="command-form">
                    <div class="form-group">
                        <label for="targetClient">Target Client</label>
                        <select id="targetClient">
                            <option value="">Select a client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="commandSelect">Command</label>
                        <select id="commandSelect" onchange="updateCommandParams()">
                            <option value="">Select a command...</option>
                        </select>
                    </div>
                    <div class="params-container" id="paramsContainer">
                        <div class="form-group">
                            <label>Command Parameters</label>
                            <div class="params-grid" id="paramsGrid"></div>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Command Description</label>
                        <div id="commandDescription" style="color: #666; font-size: 14px;">-</div>
                    </div>
                    <div class="command-actions">
                        <button class="btn btn-primary" onclick="sendCommand()" id="sendCommandBtn" disabled>Send Command</button>
                        <button class="btn btn-secondary" onclick="refreshCommandWhitelist()">Refresh Commands</button>
                    </div>
                </div>
            </div>

            <!-- Command Results -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">Command Results</div>
                    <button class="btn btn-primary" onclick="refreshResults()">Refresh Results</button>
                </div>
                <div id="resultsContainer">
                    <div class="no-data">No command results yet. Send a command to see results here.</div>
                </div>
            </div>
        </div>

        <!-- Web Shell Tab -->
        <div id="shell-tab" class="tab-content">
            <!-- Shell Info -->
            <div class="shell-info">
                <h4>Web Shell - Remote Terminal Access</h4>
                <ul>
                    <li>Select a connected client to open a remote shell session</li>
                    <li>Sessions timeout after 30 minutes of inactivity</li>
                    <li>Use Ctrl+C to interrupt commands, Ctrl+D to close the session</li>
                    <li>Maximum 3 concurrent sessions per client</li>
                </ul>
            </div>

            <!-- Shell Controls -->
            <div class="section-card">
                <div class="shell-controls">
                    <label for="shellClient"><strong>Target Client:</strong></label>
                    <select id="shellClient">
                        <option value="">Select a client...</option>
                    </select>
                    <button class="btn btn-success" onclick="connectShell()" id="connectShellBtn">Connect</button>
                    <button class="btn btn-danger" onclick="disconnectShell()" id="disconnectShellBtn" disabled>Disconnect</button>
                    <button class="btn btn-secondary" onclick="refreshShellClients()">Refresh Clients</button>
                </div>
            </div>

            <!-- Terminal -->
            <div class="section-card shell-container">
                <div class="shell-status" id="shellStatusBar">
                    <div class="shell-status-indicator" id="shellStatusIndicator"></div>
                    <span id="shellStatusText">Disconnected</span>
                </div>
                <div class="terminal-wrapper">
                    <div id="terminal"></div>
                    <div class="shell-placeholder" id="shellPlaceholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm-9-6l-4 4h3v2h2v-2h3l-4-4zm4-4h-3V6h-2v2H7l4 4 4-4z"/></svg>
                        <h3>No Active Session</h3>
                        <p>Select a client and click "Connect" to start a remote shell session</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Troubleshoot Tab -->
        <div id="ai-tab" class="tab-content">
            <!-- AI Info -->
            <div class="shell-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <h4 style="color: white;">AI-Powered Diagnostics</h4>
                <ul style="color: rgba(255,255,255,0.9);">
                    <li>Automatically collect system metrics from edge devices</li>
                    <li>AI analyzes data to identify issues and recommend solutions</li>
                    <li>Supports network, CPU, memory, disk, and service diagnostics</li>
                    <li>Requires OpenAI or Anthropic API key for AI analysis</li>
                </ul>
            </div>

            <div class="ai-container">
                <!-- Sidebar Controls -->
                <div class="ai-sidebar">
                    <h3>Diagnostics</h3>

                    <div class="form-group">
                        <label for="aiClient"><strong>Target Client</strong></label>
                        <select id="aiClient" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="">Select a client...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><strong>Categories</strong></label>
                        <div class="ai-category-list" id="aiCategoryList">
                            <div class="ai-category-item">
                                <input type="checkbox" id="cat_system" value="system" checked>
                                <label for="cat_system">System (CPU, Memory, Processes)</label>
                            </div>
                            <div class="ai-category-item">
                                <input type="checkbox" id="cat_disk" value="disk" checked>
                                <label for="cat_disk">Disk Usage</label>
                            </div>
                            <div class="ai-category-item">
                                <input type="checkbox" id="cat_network" value="network" checked>
                                <label for="cat_network">Network</label>
                            </div>
                            <div class="ai-category-item">
                                <input type="checkbox" id="cat_docker" value="docker">
                                <label for="cat_docker">Docker Containers</label>
                            </div>
                            <div class="ai-category-item">
                                <input type="checkbox" id="cat_benchmark" value="benchmark">
                                <label for="cat_benchmark">Benchmark Status</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="aiQuestion"><strong>Specific Question (Optional)</strong></label>
                        <textarea id="aiQuestion" class="ai-question-input" rows="3" placeholder="e.g., Why is the CPU usage high?"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="runAIDiagnosis()" id="runDiagnosisBtn" style="width: 100%; padding: 12px; margin-top: 10px;">
                        Run Diagnosis
                    </button>

                    <button class="btn btn-secondary" onclick="refreshAIClients()" style="width: 100%; padding: 10px; margin-top: 10px;">
                        Refresh Clients
                    </button>

                    <!-- AI Configuration -->
                    <div class="ai-config-form" id="aiConfigForm">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">AI Configuration</h4>
                        <div class="form-group">
                            <label for="aiProvider" style="font-size: 12px;">Provider</label>
                            <select id="aiProvider" style="width: 100%; padding: 8px;">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aiApiKey" style="font-size: 12px;">API Key</label>
                            <input type="password" id="aiApiKey" placeholder="Enter API key..." style="width: 100%; padding: 8px;">
                        </div>
                        <button class="btn btn-success" onclick="saveAIConfig()" style="width: 100%; padding: 8px; font-size: 12px;">
                            Save Configuration
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="ai-main">
                    <!-- Status Bar -->
                    <div class="ai-status-card">
                        <div class="ai-status-indicator" id="aiStatusIndicator"></div>
                        <span id="aiStatusText">Checking AI configuration...</span>
                    </div>

                    <!-- Results Container -->
                    <div class="ai-result-container" id="aiResultContainer">
                        <div class="ai-placeholder" id="aiPlaceholder">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            <h3>Ready for Diagnosis</h3>
                            <p>Select a client and click "Run Diagnosis" to analyze system health</p>
                            <p style="font-size: 12px; margin-top: 10px; color: #999;">
                                The AI will collect system metrics and provide actionable recommendations
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lossChart, latencyChart;
        let commandWhitelist = [];
        let adminApiKey = '';

        // Shell variables
        let shellSocket = null;
        let shellTerminal = null;
        let shellFitAddon = null;
        let shellSessionId = null;
        let shellConnected = false;

        // ========================================
        // Tab Management
        // ========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'commands') {
                loadAdminKey();
                refreshCommandWhitelist();
                refreshTargetClients();
                refreshResults();
            } else if (tabName === 'shell') {
                initShellTerminal();
                refreshShellClients();
            } else if (tabName === 'ai') {
                loadAdminKey();
                refreshAIClients();
                checkAIConfig();
            }
        }

        // ========================================
        // Toast Notifications
        // ========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ========================================
        // Admin Authentication
        // ========================================
        function loadAdminKey() {
            adminApiKey = localStorage.getItem('adminApiKey') || '';
            document.getElementById('adminApiKey').value = adminApiKey ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
            updateAuthStatus();
        }

        function saveAdminKey() {
            const keyInput = document.getElementById('adminApiKey');
            const key = keyInput.value;

            if (key && !key.startsWith('â€¢â€¢')) {
                adminApiKey = key;
                localStorage.setItem('adminApiKey', key);
                keyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                updateAuthStatus();
                showToast('API key saved', 'success');
            }
        }

        function clearAdminKey() {
            adminApiKey = '';
            localStorage.removeItem('adminApiKey');
            document.getElementById('adminApiKey').value = '';
            updateAuthStatus();
            showToast('API key cleared', 'info');
        }

        function updateAuthStatus() {
            const statusEl = document.getElementById('authStatus');
            const sendBtn = document.getElementById('sendCommandBtn');

            if (adminApiKey) {
                statusEl.textContent = 'Authenticated';
                statusEl.className = 'auth-status authenticated';
                sendBtn.disabled = false;
            } else {
                statusEl.textContent = 'Not Authenticated';
                statusEl.className = 'auth-status not-authenticated';
                sendBtn.disabled = true;
            }
        }

        // ========================================
        // Command Whitelist
        // ========================================
        async function refreshCommandWhitelist() {
            try {
                const response = await fetch('/api/commands/whitelist');
                const result = await response.json();

                commandWhitelist = result.commands || [];

                const select = document.getElementById('commandSelect');
                select.innerHTML = '<option value="">Select a command...</option>';

                // Group by category
                const categories = {};
                commandWhitelist.forEach(cmd => {
                    const cat = cmd.category || 'general';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(cmd);
                });

                Object.keys(categories).sort().forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.charAt(0).toUpperCase() + cat.slice(1);

                    categories[cat].forEach(cmd => {
                        const option = document.createElement('option');
                        option.value = cmd.id;
                        option.textContent = cmd.id;
                        option.dataset.description = cmd.description;
                        option.dataset.params = JSON.stringify(cmd.params || []);
                        group.appendChild(option);
                    });

                    select.appendChild(group);
                });

            } catch (error) {
                console.error('Error loading whitelist:', error);
                showToast('Failed to load commands', 'error');
            }
        }

        function updateCommandParams() {
            const select = document.getElementById('commandSelect');
            const option = select.selectedOptions[0];
            const paramsContainer = document.getElementById('paramsContainer');
            const paramsGrid = document.getElementById('paramsGrid');
            const descEl = document.getElementById('commandDescription');

            if (!option || !option.value) {
                paramsContainer.classList.remove('visible');
                descEl.textContent = '-';
                return;
            }

            descEl.textContent = option.dataset.description || '-';

            const params = JSON.parse(option.dataset.params || '[]');

            if (params.length > 0) {
                paramsGrid.innerHTML = '';
                params.forEach(param => {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label for="param_${param}">${param}</label>
                        <input type="text" id="param_${param}" placeholder="Enter ${param}..." />
                    `;
                    paramsGrid.appendChild(div);
                });
                paramsContainer.classList.add('visible');
            } else {
                paramsContainer.classList.remove('visible');
            }
        }

        // ========================================
        // Target Clients
        // ========================================
        async function refreshTargetClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const select = document.getElementById('targetClient');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a client...</option>';

                if (result.clients) {
                    result.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        const status = client.status === 'online' ? 'ðŸŸ¢' : 'ðŸ”´';
                        option.textContent = `${status} ${client.client_id} (${client.hostname})`;
                        select.appendChild(option);
                    });
                }

                if (currentValue) select.value = currentValue;

            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // ========================================
        // Send Command
        // ========================================
        async function sendCommand() {
            const clientId = document.getElementById('targetClient').value;
            const commandId = document.getElementById('commandSelect').value;

            if (!clientId) {
                showToast('Please select a target client', 'error');
                return;
            }
            if (!commandId) {
                showToast('Please select a command', 'error');
                return;
            }
            if (!adminApiKey) {
                showToast('Please enter your admin API key', 'error');
                return;
            }

            // Gather parameters
            const option = document.getElementById('commandSelect').selectedOptions[0];
            const paramNames = JSON.parse(option.dataset.params || '[]');
            const params = {};

            for (const param of paramNames) {
                const input = document.getElementById(`param_${param}`);
                if (input && input.value) {
                    params[param] = input.value;
                } else {
                    showToast(`Please enter value for parameter: ${param}`, 'error');
                    return;
                }
            }

            try {
                const response = await fetch('/api/commands/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-API-Key': adminApiKey
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        command_id: commandId,
                        params: params
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`Command sent! UUID: ${result.command_uuid.substring(0, 8)}...`, 'success');
                    setTimeout(refreshResults, 2000);
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error sending command:', error);
                showToast('Failed to send command', 'error');
            }
        }

        // ========================================
        // Command Results
        // ========================================
        async function refreshResults() {
            if (!adminApiKey) {
                document.getElementById('resultsContainer').innerHTML =
                    '<div class="no-data">Enter your admin API key to view results.</div>';
                return;
            }

            try {
                const response = await fetch('/api/commands/results?limit=20', {
                    headers: {
                        'X-Admin-API-Key': adminApiKey
                    }
                });

                if (response.status === 401) {
                    document.getElementById('resultsContainer').innerHTML =
                        '<div class="no-data">Invalid API key. Please check your admin key.</div>';
                    return;
                }

                const result = await response.json();
                const container = document.getElementById('resultsContainer');

                if (!result.results || result.results.length === 0) {
                    container.innerHTML = '<div class="no-data">No command results yet.</div>';
                    return;
                }

                let html = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Client</th>
                                <th>Command</th>
                                <th>Exit Code</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                result.results.slice().reverse().forEach(r => {
                    const time = new Date(r.executed_at || r.result_received_at).toLocaleString();
                    const exitClass = r.exit_code === 0 ? 'exit-code-success' : 'exit-code-error';

                    html += `
                        <tr>
                            <td>${time}</td>
                            <td><strong>${r.client_id}</strong></td>
                            <td>${r.command_id}</td>
                            <td><span class="${exitClass}">${r.exit_code}</span></td>
                            <td>${r.duration_seconds ? r.duration_seconds.toFixed(2) + 's' : '-'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="showResultDetail('${r.command_uuid}')">View</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('resultsContainer').innerHTML =
                    '<div class="no-data">Failed to load results.</div>';
            }
        }

        async function showResultDetail(uuid) {
            try {
                const response = await fetch(`/api/commands/results/${uuid}`, {
                    headers: {
                        'X-Admin-API-Key': adminApiKey
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                    const exitClass = result.exit_code === 0 ? 'exit-code-success' : 'exit-code-error';

                    modal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin-bottom: 15px;">Command Result: ${result.command_id}</h3>
                            <div class="result-meta">
                                <div class="result-meta-item"><strong>Client:</strong> ${result.client_id}</div>
                                <div class="result-meta-item"><strong>Exit Code:</strong> <span class="${exitClass}">${result.exit_code}</span></div>
                                <div class="result-meta-item"><strong>Duration:</strong> ${result.duration_seconds ? result.duration_seconds.toFixed(3) + 's' : '-'}</div>
                                <div class="result-meta-item"><strong>Executed:</strong> ${new Date(result.executed_at).toLocaleString()}</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>stdout:</strong>
                                <div class="result-output">${escapeHtml(result.stdout) || '(empty)'}</div>
                            </div>
                            ${result.stderr ? `
                                <div style="margin-top: 15px;">
                                    <strong>stderr:</strong>
                                    <div class="result-output" style="border-left: 3px solid #ef4444;">${escapeHtml(result.stderr)}</div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 20px; text-align: right;">
                                <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error loading result detail:', error);
                showToast('Failed to load result details', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // Charts (Monitoring Tab)
        // ========================================
        function initCharts() {
            const lossCtx = document.getElementById('lossChart').getContext('2d');
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');

            lossChart = new Chart(lossCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Router 1',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Router 2',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Packet Loss %' }
                        },
                        x: { title: { display: true, text: 'Time' } }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });

            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Router 1',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Router 2',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Latency (ms)' } },
                        x: { title: { display: true, text: 'Time' } }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        async function refreshData() {
            try {
                const limit = document.getElementById('timeRange').value;
                const clientId = document.getElementById('clientFilter').value;

                let url = `/api/data?limit=${limit}`;
                if (clientId && clientId !== 'all') {
                    url += `&client_id=${clientId}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.data && result.data.length > 0) {
                    updateCharts(result.data, clientId);
                    await updateStats(clientId);
                } else {
                    clearCharts();
                }

                await updateClients();

                document.getElementById('lastUpdate').textContent =
                    `Last updated: ${new Date().toLocaleString()}`;

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function updateClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const container = document.getElementById('clients-table-container');
                const countEl = document.getElementById('clients-count');
                const clientFilter = document.getElementById('clientFilter');
                const currentSelection = clientFilter.value;

                if (result.clients && result.clients.length > 0) {
                    let optionsHTML = '<option value="all">All Clients</option>';
                    result.clients.forEach(client => {
                        optionsHTML += `<option value="${client.client_id}">${client.client_id} (${client.hostname})</option>`;
                    });
                    clientFilter.innerHTML = optionsHTML;

                    if (currentSelection && Array.from(clientFilter.options).some(opt => opt.value === currentSelection)) {
                        clientFilter.value = currentSelection;
                    }
                }

                if (result.clients && result.clients.length > 0) {
                    countEl.textContent = `${result.online} online, ${result.offline} offline (${result.total} total)`;

                    let tableHTML = `
                        <table class="clients-table">
                            <thead>
                                <tr>
                                    <th>Client ID</th>
                                    <th>Hostname</th>
                                    <th>Status</th>
                                    <th>Router 1 Interface</th>
                                    <th>Router 2 Interface</th>
                                    <th>Last Seen</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    result.clients.forEach(client => {
                        const statusClass = client.status === 'online' ? 'status online' : 'status offline';
                        const lastSeen = formatTimeSince(client.seconds_since_heartbeat);

                        tableHTML += `
                            <tr>
                                <td><strong>${client.client_id}</strong></td>
                                <td>${client.hostname}</td>
                                <td><span class="client-status-badge ${statusClass}">${client.status}</span></td>
                                <td>${client.router1_interface || '-'}</td>
                                <td>${client.router2_interface || '-'}</td>
                                <td>${lastSeen}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</tbody></table>';
                    container.innerHTML = tableHTML;
                } else {
                    countEl.textContent = '0 clients';
                    container.innerHTML = '<div class="no-data">No clients connected yet</div>';
                }

            } catch (error) {
                console.error('Error fetching clients:', error);
                document.getElementById('clients-count').textContent = 'Error loading clients';
            }
        }

        function formatTimeSince(seconds) {
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function updateCharts(data, clientId) {
            const labels = [];
            const router1Loss = [];
            const router2Loss = [];
            const router1Latency = [];
            const router2Latency = [];

            data.forEach(record => {
                const timestamp = new Date(record.timestamp);
                labels.push(timestamp.toLocaleTimeString());

                router1Loss.push(record.router1?.packet_loss_pct ?? null);
                router2Loss.push(record.router2?.packet_loss_pct ?? null);
                router1Latency.push(record.router1?.avg_ms ?? null);
                router2Latency.push(record.router2?.avg_ms ?? null);
            });

            const clientInfo = clientId && clientId !== 'all' ? ` - ${clientId}` : ' - All Clients';
            document.querySelector('#lossChart').closest('.chart-container').querySelector('.chart-title').textContent =
                `Packet Loss % Over Time${clientInfo}`;
            document.querySelector('#latencyChart').closest('.chart-container').querySelector('.chart-title').textContent =
                `Average Latency (ms) Over Time${clientInfo}`;

            lossChart.data.labels = labels;
            lossChart.data.datasets[0].data = router1Loss;
            lossChart.data.datasets[1].data = router2Loss;
            lossChart.update();

            latencyChart.data.labels = labels;
            latencyChart.data.datasets[0].data = router1Latency;
            latencyChart.data.datasets[1].data = router2Latency;
            latencyChart.update();
        }

        function clearCharts() {
            lossChart.data.labels = [];
            lossChart.data.datasets[0].data = [];
            lossChart.data.datasets[1].data = [];
            lossChart.update();

            latencyChart.data.labels = [];
            latencyChart.data.datasets[0].data = [];
            latencyChart.data.datasets[1].data = [];
            latencyChart.update();
        }

        async function updateStats(clientId) {
            try {
                let url = '/api/stats';
                if (clientId && clientId !== 'all') {
                    url += `?client_id=${clientId}`;
                }

                const response = await fetch(url);
                const result = await response.json();
                const stats = result.stats;

                document.getElementById('total-records').textContent = stats.total_records || '-';

                const r1Loss = stats.router1_latest_loss;
                const r1LossEl = document.getElementById('router1-loss');
                if (r1Loss !== null && r1Loss !== undefined) {
                    r1LossEl.textContent = `${r1Loss.toFixed(1)}%`;
                    r1LossEl.className = 'stat-value ' + getLossClass(r1Loss);
                } else {
                    r1LossEl.textContent = '-';
                }

                const r2Loss = stats.router2_latest_loss;
                const r2LossEl = document.getElementById('router2-loss');
                if (r2Loss !== null && r2Loss !== undefined) {
                    r2LossEl.textContent = `${r2Loss.toFixed(1)}%`;
                    r2LossEl.className = 'stat-value ' + getLossClass(r2Loss);
                } else {
                    r2LossEl.textContent = '-';
                }

                const r1Lat = stats.router1_latest_avg_ms;
                const r1LatEl = document.getElementById('router1-latency');
                if (r1Lat !== null && r1Lat !== undefined) {
                    r1LatEl.textContent = `${r1Lat.toFixed(2)} ms`;
                    r1LatEl.className = 'stat-value ' + getLatencyClass(r1Lat);
                } else {
                    r1LatEl.textContent = '-';
                }

                const r2Lat = stats.router2_latest_avg_ms;
                const r2LatEl = document.getElementById('router2-latency');
                if (r2Lat !== null && r2Lat !== undefined) {
                    r2LatEl.textContent = `${r2Lat.toFixed(2)} ms`;
                    r2LatEl.className = 'stat-value ' + getLatencyClass(r2Lat);
                } else {
                    r2LatEl.textContent = '-';
                }

            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        function getLossClass(loss) {
            if (loss === 0) return 'good';
            if (loss < 5) return 'warning';
            return 'bad';
        }

        function getLatencyClass(latency) {
            if (latency < 50) return 'good';
            if (latency < 100) return 'warning';
            return 'bad';
        }

        // ========================================
        // Web Shell
        // ========================================
        function initShellTerminal() {
            if (shellTerminal) return; // Already initialized

            const terminalContainer = document.getElementById('terminal');

            shellTerminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    cursor: '#d4d4d4',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#cd3131',
                    green: '#0dbc79',
                    yellow: '#e5e510',
                    blue: '#2472c8',
                    magenta: '#bc3fbc',
                    cyan: '#11a8cd',
                    white: '#e5e5e5',
                    brightBlack: '#666666',
                    brightRed: '#f14c4c',
                    brightGreen: '#23d18b',
                    brightYellow: '#f5f543',
                    brightBlue: '#3b8eea',
                    brightMagenta: '#d670d6',
                    brightCyan: '#29b8db',
                    brightWhite: '#ffffff'
                }
            });

            shellFitAddon = new FitAddon.FitAddon();
            shellTerminal.loadAddon(shellFitAddon);

            shellTerminal.open(terminalContainer);
            shellFitAddon.fit();

            // Handle terminal input - encode as base64 for binary safety
            shellTerminal.onData(data => {
                if (shellConnected && shellSocket && shellSessionId) {
                    shellSocket.emit('shell_input', {
                        session_id: shellSessionId,
                        input: btoa(data)
                    });
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (shellTerminal && shellFitAddon) {
                    shellFitAddon.fit();
                    if (shellConnected && shellSocket && shellSessionId) {
                        shellSocket.emit('shell_resize', {
                            session_id: shellSessionId,
                            rows: shellTerminal.rows,
                            cols: shellTerminal.cols
                        });
                    }
                }
            });

            // Hide terminal, show placeholder initially
            terminalContainer.style.display = 'none';
        }

        async function refreshShellClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const select = document.getElementById('shellClient');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a client...</option>';

                if (result.clients) {
                    result.clients.filter(c => c.status === 'online').forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = `${client.client_id} (${client.hostname})`;
                        select.appendChild(option);
                    });
                }

                if (currentValue) select.value = currentValue;

            } catch (error) {
                console.error('Error loading shell clients:', error);
                showToast('Failed to load clients', 'error');
            }
        }

        function connectShell() {
            const clientId = document.getElementById('shellClient').value;
            if (!clientId) {
                showToast('Please select a client', 'error');
                return;
            }

            // Load admin API key from localStorage (same as Remote Commands tab)
            if (!adminApiKey) {
                adminApiKey = localStorage.getItem('adminApiKey') || '';
            }

            if (!adminApiKey) {
                showToast('Please enter your Admin API Key in the Remote Commands tab first', 'error');
                return;
            }

            updateShellStatus('connecting', `Connecting to ${clientId}...`);

            // Initialize Socket.IO connection
            if (!shellSocket) {
                shellSocket = io({
                    transports: ['websocket', 'polling']
                });

                // Socket.IO event handlers
                shellSocket.on('connect', () => {
                    console.log('[Shell] Socket connected');
                });

                shellSocket.on('disconnect', () => {
                    console.log('[Shell] Socket disconnected');
                    if (shellConnected) {
                        updateShellStatus('disconnected', 'Connection lost');
                        shellConnected = false;
                        shellSessionId = null;
                    }
                });

                shellSocket.on('shell_connected', (data) => {
                    console.log('[Shell] Session connected:', data.session_id);
                    shellSessionId = data.session_id;
                    shellConnected = true;

                    updateShellStatus('connected', `Connected to ${clientId}`);

                    // Show terminal, hide placeholder
                    document.getElementById('terminal').style.display = 'block';
                    document.getElementById('shellPlaceholder').style.display = 'none';

                    shellTerminal.clear();
                    shellFitAddon.fit();
                    shellTerminal.focus();

                    // Send initial size
                    shellSocket.emit('shell_resize', {
                        session_id: shellSessionId,
                        rows: shellTerminal.rows,
                        cols: shellTerminal.cols
                    });

                    document.getElementById('connectShellBtn').disabled = true;
                    document.getElementById('disconnectShellBtn').disabled = false;
                    document.getElementById('shellClient').disabled = true;
                });

                shellSocket.on('shell_output', (data) => {
                    if (data.session_id === shellSessionId && shellTerminal) {
                        // Decode base64 output from client
                        try {
                            const decoded = atob(data.output);
                            shellTerminal.write(decoded);
                        } catch (e) {
                            // Fallback to raw if not base64
                            shellTerminal.write(data.output || '');
                        }
                    }
                });

                shellSocket.on('shell_closed', (data) => {
                    console.log('[Shell] Session closed:', data.reason);
                    showToast(`Shell session closed: ${data.reason}`, 'info');
                    handleShellDisconnect();
                });

                shellSocket.on('shell_error', (data) => {
                    console.error('[Shell] Error:', data.error);
                    showToast(`Shell error: ${data.error}`, 'error');
                    handleShellDisconnect();
                });
            }

            // Start shell session (requires admin API key)
            shellSocket.emit('shell_start', {
                client_id: clientId,
                api_key: adminApiKey,
                rows: shellTerminal ? shellTerminal.rows : 24,
                cols: shellTerminal ? shellTerminal.cols : 80
            });
        }

        function disconnectShell() {
            if (shellSocket && shellSessionId) {
                shellSocket.emit('shell_close', {
                    session_id: shellSessionId
                });
            }
            handleShellDisconnect();
        }

        function handleShellDisconnect() {
            shellConnected = false;
            shellSessionId = null;

            updateShellStatus('disconnected', 'Disconnected');

            // Hide terminal, show placeholder
            document.getElementById('terminal').style.display = 'none';
            document.getElementById('shellPlaceholder').style.display = 'flex';

            document.getElementById('connectShellBtn').disabled = false;
            document.getElementById('disconnectShellBtn').disabled = true;
            document.getElementById('shellClient').disabled = false;
        }

        function updateShellStatus(status, text) {
            const indicator = document.getElementById('shellStatusIndicator');
            const statusText = document.getElementById('shellStatusText');

            indicator.className = 'shell-status-indicator ' + status;
            statusText.textContent = text;
        }

        // ========================================
        // AI Troubleshooting
        // ========================================
        let aiConfigured = false;

        async function checkAIConfig() {
            try {
                const response = await fetch('/api/ai/config');
                const config = await response.json();

                aiConfigured = config.configured;
                updateAIStatus(config);

            } catch (error) {
                console.error('Error checking AI config:', error);
                updateAIStatus({ configured: false, error: 'Failed to check configuration' });
            }
        }

        function updateAIStatus(config) {
            const indicator = document.getElementById('aiStatusIndicator');
            const statusText = document.getElementById('aiStatusText');

            if (config.configured) {
                indicator.className = 'ai-status-indicator';
                statusText.textContent = `AI Ready: ${config.provider} (${config.model})`;
                document.getElementById('runDiagnosisBtn').disabled = false;
            } else {
                indicator.className = 'ai-status-indicator not-configured';
                statusText.textContent = 'AI not configured - Enter API key below';
                document.getElementById('runDiagnosisBtn').disabled = true;
            }
        }

        async function saveAIConfig() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value;

            if (!apiKey) {
                showToast('Please enter an API key', 'error');
                return;
            }

            if (!adminApiKey) {
                showToast('Please save Admin API Key in Remote Commands tab first', 'error');
                return;
            }

            try {
                const response = await fetch('/api/ai/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-API-Key': adminApiKey
                    },
                    body: JSON.stringify({ provider, api_key: apiKey })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('AI configuration saved', 'success');
                    document.getElementById('aiApiKey').value = '';
                    checkAIConfig();
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error saving AI config:', error);
                showToast('Failed to save AI configuration', 'error');
            }
        }

        async function refreshAIClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const select = document.getElementById('aiClient');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a client...</option>';

                if (result.clients) {
                    result.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        const status = client.status === 'online' ? 'ðŸŸ¢' : 'ðŸ”´';
                        option.textContent = `${status} ${client.client_id} (${client.hostname})`;
                        select.appendChild(option);
                    });
                }

                if (currentValue) select.value = currentValue;

            } catch (error) {
                console.error('Error loading AI clients:', error);
            }
        }

        function getSelectedCategories() {
            const categories = [];
            document.querySelectorAll('#aiCategoryList input[type="checkbox"]:checked').forEach(cb => {
                categories.push(cb.value);
            });
            return categories;
        }

        async function runAIDiagnosis() {
            const clientId = document.getElementById('aiClient').value;
            const categories = getSelectedCategories();
            const question = document.getElementById('aiQuestion').value.trim();

            if (!clientId) {
                showToast('Please select a target client', 'error');
                return;
            }

            if (categories.length === 0) {
                showToast('Please select at least one diagnostic category', 'error');
                return;
            }

            if (!adminApiKey) {
                showToast('Please save Admin API Key in Remote Commands tab first', 'error');
                return;
            }

            // Show loading state
            const container = document.getElementById('aiResultContainer');
            container.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <p>Collecting diagnostic data from ${clientId}...</p>
                    <p style="font-size: 12px; color: #666;">This may take 30-60 seconds</p>
                </div>
            `;

            document.getElementById('runDiagnosisBtn').disabled = true;

            try {
                // Step 1: Start diagnosis and queue commands
                const startResponse = await fetch('/api/ai/diagnose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-API-Key': adminApiKey
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        categories: categories,
                        question: question || null
                    })
                });

                const startResult = await startResponse.json();

                if (!startResponse.ok) {
                    throw new Error(startResult.error || 'Failed to start diagnosis');
                }

                const sessionId = startResult.session_id;
                const commandsQueued = startResult.commands_queued;

                container.innerHTML = `
                    <div class="ai-loading">
                        <div class="spinner"></div>
                        <p>Waiting for ${commandsQueued.length} diagnostic commands to complete...</p>
                        <p style="font-size: 12px; color: #666;">Commands: ${commandsQueued.map(c => c.command_id).join(', ')}</p>
                    </div>
                `;

                // Step 2: Wait for commands to complete and collect results
                await waitForDiagnosticResults(sessionId, commandsQueued, clientId);

                // Step 3: Run AI analysis
                container.innerHTML = `
                    <div class="ai-loading">
                        <div class="spinner"></div>
                        <p>AI is analyzing the diagnostic data...</p>
                        <p style="font-size: 12px; color: #666;">Generating recommendations</p>
                    </div>
                `;

                const analyzeResponse = await fetch(`/api/ai/diagnose/${sessionId}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-API-Key': adminApiKey
                    },
                    body: JSON.stringify({ question: question || null })
                });

                const analyzeResult = await analyzeResponse.json();

                if (!analyzeResponse.ok) {
                    throw new Error(analyzeResult.error || 'Failed to analyze data');
                }

                // Display results
                displayAIDiagnosis(analyzeResult);

            } catch (error) {
                console.error('Error running AI diagnosis:', error);
                container.innerHTML = `
                    <div class="ai-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="fill: #ef4444;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <h3>Diagnosis Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                document.getElementById('runDiagnosisBtn').disabled = false;
            }
        }

        async function waitForDiagnosticResults(sessionId, commandsQueued, clientId) {
            // Poll for command results for up to 60 seconds
            const maxWaitTime = 60000;
            const pollInterval = 3000;
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
                // Get recent command results
                const resultsResponse = await fetch(`/api/commands/results?client_id=${clientId}&limit=50`, {
                    headers: { 'X-Admin-API-Key': adminApiKey }
                });

                const resultsData = await resultsResponse.json();
                const recentResults = resultsData.results || [];

                // Check which commands have completed
                let completedCount = 0;
                for (const cmd of commandsQueued) {
                    const result = recentResults.find(r => r.command_uuid === cmd.command_uuid);
                    if (result) {
                        completedCount++;
                        // Update session with this result
                        await fetch(`/api/ai/diagnose/${sessionId}/data`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Admin-API-Key': adminApiKey
                            },
                            body: JSON.stringify({
                                command_id: cmd.command_id,
                                result: {
                                    stdout: result.stdout,
                                    stderr: result.stderr,
                                    exit_code: result.exit_code,
                                    executed_at: result.executed_at
                                }
                            })
                        });
                    }
                }

                // If at least some commands completed, we can proceed
                if (completedCount >= Math.min(3, commandsQueued.length)) {
                    return;
                }

                // Wait before next poll
                await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            // Timeout - proceed with whatever data we have
            console.log('Diagnosis timeout - proceeding with partial data');
        }

        function displayAIDiagnosis(result) {
            const container = document.getElementById('aiResultContainer');

            // Convert markdown to HTML (basic conversion)
            let html = result.diagnosis || 'No diagnosis available';

            // Convert headers
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');

            // Convert code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

            // Convert inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Convert bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Convert lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

            // Wrap consecutive li elements in ul/ol
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Convert line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Clean up
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[23]>)/g, '$1');
            html = html.replace(/(<\/h[23]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');

            container.innerHTML = `
                <div class="ai-result-header">
                    <h3>Diagnosis Results - ${result.client_id}</h3>
                    <span style="color: #666; font-size: 12px;">
                        Categories: ${(result.categories_analyzed || []).join(', ')}
                    </span>
                </div>
                <div class="ai-result-content">
                    ${html}
                </div>
            `;
        }

        // ========================================
        // Initialize
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshData();

            setInterval(refreshData, 30000);

            document.getElementById('clientFilter').addEventListener('change', refreshData);
            document.getElementById('timeRange').addEventListener('change', refreshData);
        });
    </script>
</body>
</html>
