<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Router Benchmark Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: #f5f5f5;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #e5e5e5;
        }

        .tab.active {
            background: white;
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .stat-value.good { color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.bad { color: #ef4444; }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            color: #666;
            font-size: 14px;
        }

        .controls select, .controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .last-update {
            color: #999;
            font-size: 12px;
            margin-top: 10px;
        }

        .clients-section, .section-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .clients-count {
            color: #666;
            font-size: 14px;
        }

        .clients-table, .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .clients-table th, .results-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .clients-table td, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .clients-table tr:hover, .results-table tr:hover {
            background: #f9fafb;
        }

        .client-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* Admin Auth Section */
        .auth-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .auth-section .section-title {
            color: white;
            margin-bottom: 15px;
        }

        .auth-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .auth-form input {
            flex: 1;
            min-width: 300px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .auth-status {
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-status.authenticated {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }

        .auth-status.not-authenticated {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }

        /* Command Section */
        .command-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-group select, .form-group input, .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #666;
        }

        .command-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* Results Section */
        .result-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .result-meta-item {
            font-size: 13px;
        }

        .result-meta-item strong {
            color: #333;
        }

        .exit-code-success {
            color: #10b981;
            font-weight: bold;
        }

        .exit-code-error {
            color: #ef4444;
            font-weight: bold;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        .toast.info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .params-container {
            grid-column: 1 / -1;
            display: none;
        }

        .params-container.visible {
            display: block;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Router Benchmark Dashboard</h1>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('monitoring')">Monitoring</button>
            <button class="tab" onclick="switchTab('commands')">Remote Commands</button>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content active">
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="total-records">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 1 - Packet Loss</div>
                    <div class="stat-value" id="router1-loss">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 2 - Packet Loss</div>
                    <div class="stat-value" id="router2-loss">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 1 - Avg Latency</div>
                    <div class="stat-value" id="router1-latency">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Router 2 - Avg Latency</div>
                    <div class="stat-value" id="router2-latency">-</div>
                </div>
            </div>

            <div class="clients-section">
                <div class="section-header">
                    <div class="section-title">Active Clients</div>
                    <div class="clients-count" id="clients-count">-</div>
                </div>
                <div id="clients-table-container">
                    <div class="no-data">Loading clients...</div>
                </div>
            </div>

            <div class="controls">
                <label for="clientFilter">View Client:</label>
                <select id="clientFilter">
                    <option value="all" selected>All Clients</option>
                </select>

                <label for="timeRange" style="margin-left: 20px;">Time Range:</label>
                <select id="timeRange">
                    <option value="50">Last 50 records</option>
                    <option value="100" selected>Last 100 records</option>
                    <option value="200">Last 200 records</option>
                    <option value="500">Last 500 records</option>
                </select>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>

            <div class="chart-container">
                <div class="chart-title">Packet Loss % Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="lossChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Average Latency (ms) Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>

            <div class="last-update" id="lastUpdate">Last updated: -</div>
        </div>

        <!-- Commands Tab -->
        <div id="commands-tab" class="tab-content">
            <!-- Admin Authentication -->
            <div class="auth-section">
                <div class="section-title">Admin Authentication</div>
                <div class="auth-form">
                    <input type="password" id="adminApiKey" placeholder="Enter Admin API Key..." />
                    <button class="btn btn-success" onclick="saveAdminKey()">Save Key</button>
                    <button class="btn btn-secondary" onclick="clearAdminKey()">Clear</button>
                    <span class="auth-status not-authenticated" id="authStatus">Not Authenticated</span>
                </div>
            </div>

            <!-- Send Command -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">Send Command</div>
                </div>
                <div class="command-form">
                    <div class="form-group">
                        <label for="targetClient">Target Client</label>
                        <select id="targetClient">
                            <option value="">Select a client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="commandSelect">Command</label>
                        <select id="commandSelect" onchange="updateCommandParams()">
                            <option value="">Select a command...</option>
                        </select>
                    </div>
                    <div class="params-container" id="paramsContainer">
                        <div class="form-group">
                            <label>Command Parameters</label>
                            <div class="params-grid" id="paramsGrid"></div>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Command Description</label>
                        <div id="commandDescription" style="color: #666; font-size: 14px;">-</div>
                    </div>
                    <div class="command-actions">
                        <button class="btn btn-primary" onclick="sendCommand()" id="sendCommandBtn" disabled>Send Command</button>
                        <button class="btn btn-secondary" onclick="refreshCommandWhitelist()">Refresh Commands</button>
                    </div>
                </div>
            </div>

            <!-- Command Results -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">Command Results</div>
                    <button class="btn btn-primary" onclick="refreshResults()">Refresh Results</button>
                </div>
                <div id="resultsContainer">
                    <div class="no-data">No command results yet. Send a command to see results here.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lossChart, latencyChart;
        let commandWhitelist = [];
        let adminApiKey = '';

        // ========================================
        // Tab Management
        // ========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'commands') {
                loadAdminKey();
                refreshCommandWhitelist();
                refreshTargetClients();
                refreshResults();
            }
        }

        // ========================================
        // Toast Notifications
        // ========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ========================================
        // Admin Authentication
        // ========================================
        function loadAdminKey() {
            adminApiKey = localStorage.getItem('adminApiKey') || '';
            document.getElementById('adminApiKey').value = adminApiKey ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
            updateAuthStatus();
        }

        function saveAdminKey() {
            const keyInput = document.getElementById('adminApiKey');
            const key = keyInput.value;

            if (key && !key.startsWith('â€¢â€¢')) {
                adminApiKey = key;
                localStorage.setItem('adminApiKey', key);
                keyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                updateAuthStatus();
                showToast('API key saved', 'success');
            }
        }

        function clearAdminKey() {
            adminApiKey = '';
            localStorage.removeItem('adminApiKey');
            document.getElementById('adminApiKey').value = '';
            updateAuthStatus();
            showToast('API key cleared', 'info');
        }

        function updateAuthStatus() {
            const statusEl = document.getElementById('authStatus');
            const sendBtn = document.getElementById('sendCommandBtn');

            if (adminApiKey) {
                statusEl.textContent = 'Authenticated';
                statusEl.className = 'auth-status authenticated';
                sendBtn.disabled = false;
            } else {
                statusEl.textContent = 'Not Authenticated';
                statusEl.className = 'auth-status not-authenticated';
                sendBtn.disabled = true;
            }
        }

        // ========================================
        // Command Whitelist
        // ========================================
        async function refreshCommandWhitelist() {
            try {
                const response = await fetch('/api/commands/whitelist');
                const result = await response.json();

                commandWhitelist = result.commands || [];

                const select = document.getElementById('commandSelect');
                select.innerHTML = '<option value="">Select a command...</option>';

                // Group by category
                const categories = {};
                commandWhitelist.forEach(cmd => {
                    const cat = cmd.category || 'general';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(cmd);
                });

                Object.keys(categories).sort().forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.charAt(0).toUpperCase() + cat.slice(1);

                    categories[cat].forEach(cmd => {
                        const option = document.createElement('option');
                        option.value = cmd.id;
                        option.textContent = cmd.id;
                        option.dataset.description = cmd.description;
                        option.dataset.params = JSON.stringify(cmd.params || []);
                        group.appendChild(option);
                    });

                    select.appendChild(group);
                });

            } catch (error) {
                console.error('Error loading whitelist:', error);
                showToast('Failed to load commands', 'error');
            }
        }

        function updateCommandParams() {
            const select = document.getElementById('commandSelect');
            const option = select.selectedOptions[0];
            const paramsContainer = document.getElementById('paramsContainer');
            const paramsGrid = document.getElementById('paramsGrid');
            const descEl = document.getElementById('commandDescription');

            if (!option || !option.value) {
                paramsContainer.classList.remove('visible');
                descEl.textContent = '-';
                return;
            }

            descEl.textContent = option.dataset.description || '-';

            const params = JSON.parse(option.dataset.params || '[]');

            if (params.length > 0) {
                paramsGrid.innerHTML = '';
                params.forEach(param => {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label for="param_${param}">${param}</label>
                        <input type="text" id="param_${param}" placeholder="Enter ${param}..." />
                    `;
                    paramsGrid.appendChild(div);
                });
                paramsContainer.classList.add('visible');
            } else {
                paramsContainer.classList.remove('visible');
            }
        }

        // ========================================
        // Target Clients
        // ========================================
        async function refreshTargetClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const select = document.getElementById('targetClient');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a client...</option>';

                if (result.clients) {
                    result.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        const status = client.status === 'online' ? 'ðŸŸ¢' : 'ðŸ”´';
                        option.textContent = `${status} ${client.client_id} (${client.hostname})`;
                        select.appendChild(option);
                    });
                }

                if (currentValue) select.value = currentValue;

            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // ========================================
        // Send Command
        // ========================================
        async function sendCommand() {
            const clientId = document.getElementById('targetClient').value;
            const commandId = document.getElementById('commandSelect').value;

            if (!clientId) {
                showToast('Please select a target client', 'error');
                return;
            }
            if (!commandId) {
                showToast('Please select a command', 'error');
                return;
            }
            if (!adminApiKey) {
                showToast('Please enter your admin API key', 'error');
                return;
            }

            // Gather parameters
            const option = document.getElementById('commandSelect').selectedOptions[0];
            const paramNames = JSON.parse(option.dataset.params || '[]');
            const params = {};

            for (const param of paramNames) {
                const input = document.getElementById(`param_${param}`);
                if (input && input.value) {
                    params[param] = input.value;
                } else {
                    showToast(`Please enter value for parameter: ${param}`, 'error');
                    return;
                }
            }

            try {
                const response = await fetch('/api/commands/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-API-Key': adminApiKey
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        command_id: commandId,
                        params: params
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`Command sent! UUID: ${result.command_uuid.substring(0, 8)}...`, 'success');
                    setTimeout(refreshResults, 2000);
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error sending command:', error);
                showToast('Failed to send command', 'error');
            }
        }

        // ========================================
        // Command Results
        // ========================================
        async function refreshResults() {
            if (!adminApiKey) {
                document.getElementById('resultsContainer').innerHTML =
                    '<div class="no-data">Enter your admin API key to view results.</div>';
                return;
            }

            try {
                const response = await fetch('/api/commands/results?limit=20', {
                    headers: {
                        'X-Admin-API-Key': adminApiKey
                    }
                });

                if (response.status === 401) {
                    document.getElementById('resultsContainer').innerHTML =
                        '<div class="no-data">Invalid API key. Please check your admin key.</div>';
                    return;
                }

                const result = await response.json();
                const container = document.getElementById('resultsContainer');

                if (!result.results || result.results.length === 0) {
                    container.innerHTML = '<div class="no-data">No command results yet.</div>';
                    return;
                }

                let html = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Client</th>
                                <th>Command</th>
                                <th>Exit Code</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                result.results.slice().reverse().forEach(r => {
                    const time = new Date(r.executed_at || r.result_received_at).toLocaleString();
                    const exitClass = r.exit_code === 0 ? 'exit-code-success' : 'exit-code-error';

                    html += `
                        <tr>
                            <td>${time}</td>
                            <td><strong>${r.client_id}</strong></td>
                            <td>${r.command_id}</td>
                            <td><span class="${exitClass}">${r.exit_code}</span></td>
                            <td>${r.duration_seconds ? r.duration_seconds.toFixed(2) + 's' : '-'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="showResultDetail('${r.command_uuid}')">View</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('resultsContainer').innerHTML =
                    '<div class="no-data">Failed to load results.</div>';
            }
        }

        async function showResultDetail(uuid) {
            try {
                const response = await fetch(`/api/commands/results/${uuid}`, {
                    headers: {
                        'X-Admin-API-Key': adminApiKey
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                    const exitClass = result.exit_code === 0 ? 'exit-code-success' : 'exit-code-error';

                    modal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin-bottom: 15px;">Command Result: ${result.command_id}</h3>
                            <div class="result-meta">
                                <div class="result-meta-item"><strong>Client:</strong> ${result.client_id}</div>
                                <div class="result-meta-item"><strong>Exit Code:</strong> <span class="${exitClass}">${result.exit_code}</span></div>
                                <div class="result-meta-item"><strong>Duration:</strong> ${result.duration_seconds ? result.duration_seconds.toFixed(3) + 's' : '-'}</div>
                                <div class="result-meta-item"><strong>Executed:</strong> ${new Date(result.executed_at).toLocaleString()}</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>stdout:</strong>
                                <div class="result-output">${escapeHtml(result.stdout) || '(empty)'}</div>
                            </div>
                            ${result.stderr ? `
                                <div style="margin-top: 15px;">
                                    <strong>stderr:</strong>
                                    <div class="result-output" style="border-left: 3px solid #ef4444;">${escapeHtml(result.stderr)}</div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 20px; text-align: right;">
                                <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error loading result detail:', error);
                showToast('Failed to load result details', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // Charts (Monitoring Tab)
        // ========================================
        function initCharts() {
            const lossCtx = document.getElementById('lossChart').getContext('2d');
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');

            lossChart = new Chart(lossCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Router 1',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Router 2',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Packet Loss %' }
                        },
                        x: { title: { display: true, text: 'Time' } }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });

            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Router 1',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Router 2',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Latency (ms)' } },
                        x: { title: { display: true, text: 'Time' } }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        async function refreshData() {
            try {
                const limit = document.getElementById('timeRange').value;
                const clientId = document.getElementById('clientFilter').value;

                let url = `/api/data?limit=${limit}`;
                if (clientId && clientId !== 'all') {
                    url += `&client_id=${clientId}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.data && result.data.length > 0) {
                    updateCharts(result.data, clientId);
                    await updateStats(clientId);
                } else {
                    clearCharts();
                }

                await updateClients();

                document.getElementById('lastUpdate').textContent =
                    `Last updated: ${new Date().toLocaleString()}`;

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function updateClients() {
            try {
                const response = await fetch('/api/clients');
                const result = await response.json();

                const container = document.getElementById('clients-table-container');
                const countEl = document.getElementById('clients-count');
                const clientFilter = document.getElementById('clientFilter');
                const currentSelection = clientFilter.value;

                if (result.clients && result.clients.length > 0) {
                    let optionsHTML = '<option value="all">All Clients</option>';
                    result.clients.forEach(client => {
                        optionsHTML += `<option value="${client.client_id}">${client.client_id} (${client.hostname})</option>`;
                    });
                    clientFilter.innerHTML = optionsHTML;

                    if (currentSelection && Array.from(clientFilter.options).some(opt => opt.value === currentSelection)) {
                        clientFilter.value = currentSelection;
                    }
                }

                if (result.clients && result.clients.length > 0) {
                    countEl.textContent = `${result.online} online, ${result.offline} offline (${result.total} total)`;

                    let tableHTML = `
                        <table class="clients-table">
                            <thead>
                                <tr>
                                    <th>Client ID</th>
                                    <th>Hostname</th>
                                    <th>Status</th>
                                    <th>Router 1 Interface</th>
                                    <th>Router 2 Interface</th>
                                    <th>Last Seen</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    result.clients.forEach(client => {
                        const statusClass = client.status === 'online' ? 'status online' : 'status offline';
                        const lastSeen = formatTimeSince(client.seconds_since_heartbeat);

                        tableHTML += `
                            <tr>
                                <td><strong>${client.client_id}</strong></td>
                                <td>${client.hostname}</td>
                                <td><span class="client-status-badge ${statusClass}">${client.status}</span></td>
                                <td>${client.router1_interface || '-'}</td>
                                <td>${client.router2_interface || '-'}</td>
                                <td>${lastSeen}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</tbody></table>';
                    container.innerHTML = tableHTML;
                } else {
                    countEl.textContent = '0 clients';
                    container.innerHTML = '<div class="no-data">No clients connected yet</div>';
                }

            } catch (error) {
                console.error('Error fetching clients:', error);
                document.getElementById('clients-count').textContent = 'Error loading clients';
            }
        }

        function formatTimeSince(seconds) {
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function updateCharts(data, clientId) {
            const labels = [];
            const router1Loss = [];
            const router2Loss = [];
            const router1Latency = [];
            const router2Latency = [];

            data.forEach(record => {
                const timestamp = new Date(record.timestamp);
                labels.push(timestamp.toLocaleTimeString());

                router1Loss.push(record.router1?.packet_loss_pct ?? null);
                router2Loss.push(record.router2?.packet_loss_pct ?? null);
                router1Latency.push(record.router1?.avg_ms ?? null);
                router2Latency.push(record.router2?.avg_ms ?? null);
            });

            const clientInfo = clientId && clientId !== 'all' ? ` - ${clientId}` : ' - All Clients';
            document.querySelector('#lossChart').closest('.chart-container').querySelector('.chart-title').textContent =
                `Packet Loss % Over Time${clientInfo}`;
            document.querySelector('#latencyChart').closest('.chart-container').querySelector('.chart-title').textContent =
                `Average Latency (ms) Over Time${clientInfo}`;

            lossChart.data.labels = labels;
            lossChart.data.datasets[0].data = router1Loss;
            lossChart.data.datasets[1].data = router2Loss;
            lossChart.update();

            latencyChart.data.labels = labels;
            latencyChart.data.datasets[0].data = router1Latency;
            latencyChart.data.datasets[1].data = router2Latency;
            latencyChart.update();
        }

        function clearCharts() {
            lossChart.data.labels = [];
            lossChart.data.datasets[0].data = [];
            lossChart.data.datasets[1].data = [];
            lossChart.update();

            latencyChart.data.labels = [];
            latencyChart.data.datasets[0].data = [];
            latencyChart.data.datasets[1].data = [];
            latencyChart.update();
        }

        async function updateStats(clientId) {
            try {
                let url = '/api/stats';
                if (clientId && clientId !== 'all') {
                    url += `?client_id=${clientId}`;
                }

                const response = await fetch(url);
                const result = await response.json();
                const stats = result.stats;

                document.getElementById('total-records').textContent = stats.total_records || '-';

                const r1Loss = stats.router1_latest_loss;
                const r1LossEl = document.getElementById('router1-loss');
                if (r1Loss !== null && r1Loss !== undefined) {
                    r1LossEl.textContent = `${r1Loss.toFixed(1)}%`;
                    r1LossEl.className = 'stat-value ' + getLossClass(r1Loss);
                } else {
                    r1LossEl.textContent = '-';
                }

                const r2Loss = stats.router2_latest_loss;
                const r2LossEl = document.getElementById('router2-loss');
                if (r2Loss !== null && r2Loss !== undefined) {
                    r2LossEl.textContent = `${r2Loss.toFixed(1)}%`;
                    r2LossEl.className = 'stat-value ' + getLossClass(r2Loss);
                } else {
                    r2LossEl.textContent = '-';
                }

                const r1Lat = stats.router1_latest_avg_ms;
                const r1LatEl = document.getElementById('router1-latency');
                if (r1Lat !== null && r1Lat !== undefined) {
                    r1LatEl.textContent = `${r1Lat.toFixed(2)} ms`;
                    r1LatEl.className = 'stat-value ' + getLatencyClass(r1Lat);
                } else {
                    r1LatEl.textContent = '-';
                }

                const r2Lat = stats.router2_latest_avg_ms;
                const r2LatEl = document.getElementById('router2-latency');
                if (r2Lat !== null && r2Lat !== undefined) {
                    r2LatEl.textContent = `${r2Lat.toFixed(2)} ms`;
                    r2LatEl.className = 'stat-value ' + getLatencyClass(r2Lat);
                } else {
                    r2LatEl.textContent = '-';
                }

            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        function getLossClass(loss) {
            if (loss === 0) return 'good';
            if (loss < 5) return 'warning';
            return 'bad';
        }

        function getLatencyClass(latency) {
            if (latency < 50) return 'good';
            if (latency < 100) return 'warning';
            return 'bad';
        }

        // ========================================
        // Initialize
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshData();

            setInterval(refreshData, 30000);

            document.getElementById('clientFilter').addEventListener('change', refreshData);
            document.getElementById('timeRange').addEventListener('change', refreshData);
        });
    </script>
</body>
</html>
